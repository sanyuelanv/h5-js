/**
 * Created by sanyuelanv on 2015/8/12.
 */
var scratch=function(n){var b=n.id||-1;var p=n.size||{w:"200",h:"200"};var k=n.pos||{x:"0",y:"0"};n.bottom=n.bottom||"#000";var a=(n.bottom.indexOf("#"))?"background-image:url("+n.bottom+")":"background-color:"+n.bottom;var l=n.surface||"#fff";var d=n.alpha||1;var j=n.precent||-1;var g=n.touchSize||1000;this.resetCanvas=function(){i.clearRect(0,0,p.w,p.h);i.globalCompositeOperation="source-over";i.globalAlpha=d;if(l.indexOf("#")==-1){var q=new Image();q.src=l;i.drawImage(q,0,0,p.w,p.h)}else{i.fillStyle=l;i.fillRect(0,0,p.w,p.h)}i.globalCompositeOperation="destination-out";i.globalAlpha=1;area=0};this.changeBottom=function(q){q=q||n.bottom;var r=document.getElementById("scratch");if(q.indexOf("#")==-1){r.style.backgroundImage="url("+q+")"}else{r.style.background="none";r.style.backgroundColor=q}};var c=undefined,i=undefined,e={left:k.x-1,top:k.y-1};var o=[];var m=p.w*p.h;var h=false;var f={init:function(){f.createDom()},createDom:function(){if(b==-1){var s=document.getElementsByTagName("body")[0]}else{var s=document.getElementById(b)}var q="width:"+p.w+"px;height:"+p.h+"px;position:absolute;left:"+k.x+"px;top:"+k.y+"px;"+a+";overflow:hidden";var r="<div id='scratch' style='"+q+"'><canvas id='scratch_canvas' height='"+p.h+"' width='"+p.w+"'></canvas></div>";s.innerHTML=s.innerHTML+r;f.creatCanvas()},creatCanvas:function(){c=document.getElementById("scratch_canvas");i=c.getContext("2d");i.globalAlpha=d;if(l.indexOf("#")==-1){var q=new Image();q.src=l;q.onload=function(){i.drawImage(q,0,0,p.w,p.h);f.DrawIng()}}else{i.fillStyle=l;i.fillRect(0,0,p.w,p.h);f.DrawIng()}},DrawIng:function(){i.globalCompositeOperation="destination-out";i.globalAlpha=1;i.lineCap="round";i.lineJoin="round";i.pX=undefined;i.pY=undefined;i.lineWidth=g;var s=navigator.userAgent;var r=/android|adr/gi.test(s);var q=/iphone|ipod|ipad/gi.test(s)&&!r;var t=!r&&!q;if(t){c.addEventListener("mousedown",f.startMouse,false);c.addEventListener("mousemove",f.moveMouse,false);c.addEventListener("mouseup",f.endMouse,false)}else{c.addEventListener("touchstart",f.startTouch,false);c.addEventListener("touchmove",f.moveTouch,false)}},startMouse:function(q){h=true;var r=1;o[r]={x:q.pageX-e.left,y:q.pageY-e.top};i.beginPath();i.arc(o[r].x,o[r].y,i.lineWidth/2,0,Math.PI*2,true);i.closePath();i.fill();q.preventDefault()},moveMouse:function(t){if(!h){return}var u=1;var s=t.pageX-e.left-o[u].x;var r=t.pageY-e.top-o[u].y;var q=f.move(u,s,r);o[u].x=q.x;o[u].y=q.y;t.preventDefault()},endMouse:function(){h=false;event.preventDefault()},startTouch:function(r){for(var q=0;q<r.touches.length;q++){var t=r.touches[q];var s=t.identifier;o[s]={x:t.pageX-e.left,y:t.pageY-e.top};i.beginPath();i.arc(o[s].x,o[s].y,i.lineWidth/2,0,Math.PI*2,true);i.closePath();i.fill();f.calculate()}r.preventDefault()},moveTouch:function(u){for(var r=0;r<u.touches.length;r++){var w=u.touches[r];var v=w.identifier;var t=w.pageX-e.left-o[v].x;var s=w.pageY-e.top-o[v].y;var q=f.move(v,t,s);o[v].x=q.x;o[v].y=q.y}u.preventDefault()},move:function(q,s,r){i.beginPath();i.moveTo(o[q].x,o[q].y);i.lineTo(o[q].x+s,o[q].y+r);i.stroke();i.closePath();f.calculate();return{x:o[q].x+s,y:o[q].y+r}},calculate:function(q){if(j==-1){return}var t=0;imageData=i.getImageData(0,0,c.width,c.height);for(var r=0,s=imageData.data.length;r<s;r=r+4){if(imageData.data[r]===0&&imageData.data[r+1]===0&&imageData.data[r+2]===0&&imageData.data[r+3]===0){t++}}if(t/m>j){i.clearRect(0,0,p.w,p.h)}}};return f.init()};